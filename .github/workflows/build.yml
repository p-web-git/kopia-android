name: build-kopia-android

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: self-hosted
    env:
      ANDROID_NDK_ZIP: android-ndk-r28c-linux.zip
      ANDROID_NDK_DIR: android-ndk-r28c
      # go install will put the binary here
      GOBIN: ${{ github.workspace }}/out

    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22.x'

      - name: Get Android NDK
        run: |
          wget https://dl.google.com/android/repository/${ANDROID_NDK_ZIP}
          unzip -q ${ANDROID_NDK_ZIP}

      - name: Build Kopia (Android/arm64, CGO, netcgo)
        run: |
          export ANDROID_NDK="${PWD}/${ANDROID_NDK_DIR}"
          export CC="$ANDROID_NDK/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android24-clang"
          export CXX="$ANDROID_NDK/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android24-clang++"
          export GOOS=android GOARCH=arm64 CGO_ENABLED=1
          mkdir -p "$GOBIN"
          # netcgo ensures the cgo DNS resolver is used
          go install -tags netcgo github.com/kopia/kopia@v0.21.1
          ls -l "$GOBIN"

      - name: Upload Android binary
        uses: actions/upload-artifact@v4
        with:
          name: kopia-android-arm64
          path: out/kopia
